<script>
/*
  Group live loader (updated)
  - Auto-refresh every 30 seconds
  - No UI breaking
*/

(async function loadGroup(firstLoad = false) {
  const GROUP_ID = 35398646;
  const memberListEl = document.getElementById('member-list');
  const membersCountEl = document.getElementById('live-members');
  const onlineCountEl = document.getElementById('live-online');
  const statusEl = document.getElementById('home-status');
  const groupNameEl = document.getElementById('group-name');
  const groupCreatedEl = document.getElementById('group-created');

  function setStatus(text, isError = false) {
    statusEl.textContent = text;
    statusEl.style.color = isError ? '#ff8b8b' : 'var(--muted)';
  }

  async function safeFetch(url, opts) {
    try {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    } catch {
      return null;
    }
  }

  if (firstLoad) setStatus("Loading group data...");

  // GET roles + group info
  const rolesData = await safeFetch(`https://groups.roblox.com/v1/groups/${GROUP_ID}/roles`);
  if (!rolesData) {
    setStatus("Failed to load group data (CORS or network).", true);
    return;
  }

  const roles = rolesData.roles;
  const roleMap = {};
  roles.forEach(r => roleMap[r.id] = { name: r.name, rank: r.rank });

  if (rolesData.group?.name) groupNameEl.textContent = rolesData.group.name;
  if (rolesData.group?.created)
    groupCreatedEl.textContent = new Date(rolesData.group.created).toLocaleDateString();

  // FETCH last 200 members
  async function fetchMembers(limit = 200) {
    let out = [], cursor = null;
    while (out.length < limit) {
      const url = new URL(`https://groups.roblox.com/v1/groups/${GROUP_ID}/users`);
      url.searchParams.set("limit", 100);
      if (cursor) url.searchParams.set("cursor", cursor);

      const data = await safeFetch(url.toString());
      if (!data?.data) break;

      out = out.concat(data.data);
      cursor = data.nextPageCursor;
      if (!cursor) break;
    }
    return out;
  }

  const rawMembers = await fetchMembers(200);
  if (!rawMembers.length) {
    setStatus("No members found.", true);
    return;
  }

  // Show total members
  membersCountEl.textContent = rawMembers.length.toLocaleString();

  // Normalize member objects
  const members = rawMembers.map(m => {
    const user = m.user || m;
    const role = m.role;
    return {
      id: user.id || user.userId,
      name: user.username || user.name,
      roleId: role?.id || m.roleId
    };
  });

  // PRESENCE CHECK
  const userIds = members.map(m => m.id);
  let presenceMap = {};

  // Try batch presence
  try {
    const res = await safeFetch(`https://presence.roblox.com/v1/presence/users`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ userIds })
    });

    if (Array.isArray(res)) {
      res.forEach(p => {
        const uid = p.userId || p.UserId;
        const isOnline = p.isOnline ?? (p.UserPresenceType !== 0);
        presenceMap[uid] = !!isOnline;
      });
    }
  } catch {}

  // Fallback legacy presence (slow)
  if (Object.keys(presenceMap).length === 0) {
    for (const id of userIds) {
      const p = await safeFetch(`https://api.roblox.com/Users/${id}/Onlinestatus/`);
      if (p) presenceMap[id] = !!p.IsOnline;
    }
  }

  // Count online users
  const onlineCount = Object.values(presenceMap).filter(Boolean).length;
  onlineCountEl.textContent = onlineCount.toLocaleString();

  // Render member list ONLY on first load
  if (firstLoad) {
    const groups = {};
    members.forEach(m => {
      const roleName = roleMap[m.roleId]?.name || "Member";
      if (!groups[roleName]) groups[roleName] = [];
      groups[roleName].push({
        ...m,
        online: presenceMap[m.id] || false
      });
    });

    const orderedRoles = roles.sort((a, b) => a.rank - b.rank).map(r => r.name);

    memberListEl.innerHTML = "";
    orderedRoles.forEach(role => {
      if (!groups[role]) return;

      const title = document.createElement("div");
      title.textContent = `${role} (${groups[role].length})`;
      title.style.cssText = "font-weight:700;margin-bottom:6px;color:#fff;";
      memberListEl.appendChild(title);

      groups[role].forEach(u => {
        const div = document.createElement("div");
        div.className = "member-item";
        div.style.cssText = `
          display:flex;justify-content:space-between;margin-bottom:4px;
        `;
        div.innerHTML = `
          <span>${u.name}</span>
          <span style="font-size:13px;font-weight:700;color:${u.online ? '#73bef8' : 'var(--muted)'}">
            ${u.online ? 'Online' : 'Offline'}
          </span>
        `;
        memberListEl.appendChild(div);
      });
    });
  }

  setStatus("Updated.");
})();

// AUTO-REFRESH every 30 seconds
setInterval(() => loadGroup(false), 30000);
</script>
